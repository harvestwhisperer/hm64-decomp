#include "common.h"

#include "system/audio.h"

#include "game/gameAudio.h"

// shared bss (system/audio.c)
extern Sfx gSfx[4];
extern SequenceInfo gAudioSequences[4];

// data
WaveTableInfo waveTableAddresses[1] = {
    { (u8*)0xE93080, (u8*)0xE99910, (u8*)0xE99910 },
};

Addresses sequenceRomAddresses[] = {
    { 0x00FD8510, 0x00FDAD00 },
    { 0x00FDAD00, 0x00FDD6C0 },
    { 0x00FDD6C0, 0x00FDFB50 },
    { 0x00FDFB50, 0x00FE12F0 },
    { 0x00FE12F0, 0x00FE27B0 },
    { 0x00FE27B0, 0x00FE4D20 },
    { 0x00FE4D20, 0x00FE5E50 },
    { 0x00FE5E50, 0x00FE6E60 },
    { 0x00FE6E60, 0x00FE7E00 },
    { 0x00FE7E00, 0x00FE9040 },
    { 0x00FE9040, 0x00FEAB70 },
    { 0x00FEAB70, 0x00FEB8F0 },
    { 0x00FEB8F0, 0x00FED5F0 },
    { 0x00FED5F0, 0x00FEEA40 },
    { 0x00FEEA40, 0x00FEF9F0 },
    { 0x00FEF9F0, 0x00FF1CD0 },
    { 0x00FF1CD0, 0x00FF3760 },
    { 0x00FF3760, 0x00FF4160 },
    { 0x00FF4160, 0x00FF4750 },
    { 0x00FF4750, 0x00FF6300 },
    { 0x00FF6300, 0x00FF6ED0 },
    { 0x00FF6ED0, 0x00FF7D80 },
    { 0x00FF7D80, 0x00FF9370 },
    { 0x00FF9370, 0x00FF95A0 },
    { 0x00FF95A0, 0x00FF9840 },
    { 0x00FF9840, 0x00FF99F0 },
    { 0x00FF99F0, 0x00FF9BC0 },
    { 0x00FF9BC0, 0x00FF9DC0 },
    { 0x00FF9DC0, 0x00FF9F40 },
    { 0x00FF9F40, 0x00FFA7B0 },
    { 0x00FFA7B0, 0x00FFA950 },
    { 0x00FFA950, 0x00FFAF80 },
    { 0x00FFAF80, 0x00FFB090 },
    { 0x00FFB090, 0x00FFB700 },
    { 0x00FFB700, 0x00FFC530 },
    { 0x00FFC530, 0x00FFC9F0 },
    { 0x00FFC9F0, 0x00FFCC40 },
    { 0x00FFCC40, 0x00FFCE10 },
    { 0x00FFCE10, 0x00FFD490 },
    { 0x00FFD490, 0x00FFD680 },
    { 0x00FFD680, 0x00FFD820 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
};

Addresses sfxRomAddresses[] = {
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00FFE620, 0x00FFE720 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00FFF350, 0x00FFF470 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00FFF470, 0x00FFF580 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00FFEC30, 0x00FFED40 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00FFE720, 0x00FFE820 },
    { 0x00FFE820, 0x00FFE920 },
    { 0x00FFE920, 0x00FFEA30 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00FFEF50, 0x00FFF070 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00FFF070, 0x00FFF180 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00FFEE40, 0x00FFEF50 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00FFED40, 0x00FFEE40 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00FFD820, 0x00FFD920 },
    { 0x00FFD920, 0x00FFDA20 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00FFDA30, 0x00FFDB80 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00FFDBA0, 0x00FFDCD0 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00FFF580, 0x00FFF700 },
    { 0x00FFDCF0, 0x00FFDEE0 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00FFDEF0, 0x00FFE520 },
    { 0x00000000, 0x00000000 },
    { 0x00FFF180, 0x00FFF350 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
    { 0x00000000, 0x00000000 },
};

u8 audioTypeTable[] = {
    SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, 
    SFX_TYPE, SFX_TYPE, SFX_TYPE, SONG_TYPE,SFX_TYPE, SFX_TYPE, 
    SFX_TYPE, SONG_TYPE,SFX_TYPE, SFX_TYPE, SONG_TYPE,SFX_TYPE, 
    SFX_TYPE, SONG_TYPE,SFX_TYPE, SFX_TYPE, SFX_TYPE, SONG_TYPE,
    SONG_TYPE, SONG_TYPE,SFX_TYPE, SFX_TYPE, SFX_TYPE, SONG_TYPE,
    SFX_TYPE, SFX_TYPE, SONG_TYPE,SFX_TYPE, SFX_TYPE, SONG_TYPE,
    SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, 
    SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SONG_TYPE, SFX_TYPE, 
    SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, 
    SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, 
    SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, 
    SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, 
    SONG_TYPE, SONG_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, 
    SONG_TYPE, SFX_TYPE, SFX_TYPE, SONG_TYPE,SFX_TYPE, SFX_TYPE, 
    SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, 
    0x03, SONG_TYPE,SFX_TYPE, SFX_TYPE, SFX_TYPE, SFX_TYPE, 
    SONG_TYPE, SFX_TYPE, SONG_TYPE, 0x00, 0x00, 0x00, 0x00, 
    
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // this is probably separate unused array 
    0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 
    0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 
    0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 
    0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 
    0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 
    0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 
    0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 
    0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 
    0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 
    0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 
    0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

s32 volumesTable[] = {
    128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
    128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
    128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
    128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
    128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
    128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
    128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
    128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
    128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
    128, 128, 128, 128, 128, 128, 128, 128, 128, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0,
};


//INCLUDE_ASM("asm/nonmatchings/game/gameAudio", initializeWaveTable);

void initializeWaveTable(u16 waveTableIndex) {
    setAudioSequenceBank(waveTableAddresses[waveTableIndex].pbk_addr, waveTableAddresses[waveTableIndex].pbk_end, waveTableAddresses[waveTableIndex].wbk_addr);
}

//INCLUDE_ASM("asm/nonmatchings/game/gameAudio", setCurrentAudioSequence);

void setCurrentAudioSequence(u16 sequenceIndex) {

    if (sequenceIndex < TOTAL_SEQUENCES) {
        setAudioSequence(0, (u8*)sequenceRomAddresses[sequenceIndex].romAddrStart, (u8*)sequenceRomAddresses[sequenceIndex].romAddrEnd);
    }
    
    setAudioSequenceVolumes(0, 0, 0);

}

//INCLUDE_ASM("asm/nonmatchings/game/gameAudio", stopAudioSequenceWithDefaultFadeOut);

void stopAudioSequenceWithDefaultFadeOut(u16 sequenceIndex) {
    if (sequenceIndex < TOTAL_SEQUENCES) {
        stopAudioSequenceWithFadeOut(0, 32);
    }
}

//INCLUDE_ASM("asm/nonmatchings/game/gameAudio", stopCurrentAudioSequence);

void stopCurrentAudioSequence(u16 sequenceIndex) {
    if (sequenceIndex  < TOTAL_SEQUENCES) {
        stopAudioSequence(0);
    }
}

//INCLUDE_ASM("asm/nonmatchings/game/gameAudio", checkDefaultSequenceChannelOpen);

// check if first sequence slot is open/not set
bool checkDefaultSequenceChannelOpen(u16 sequenceIndex) {
    
    u8 result = FALSE;
    
    if (sequenceIndex < TOTAL_SEQUENCES) {
        result = gAudioSequences[0].flags == 0;
    }

    if (sequenceIndex == 0xFF) {
        result = TRUE;
    }
    
    return result;

}

//INCLUDE_ASM("asm/nonmatchings/game/gameAudio", setAudioSequenceVolume);

void setAudioSequenceVolume(u16 sequenceIndex, u32 targetVolume) {
    if (sequenceIndex < TOTAL_SEQUENCES) {
        setAudioSequenceVolumes(0, targetVolume, 32);
    }
}

//INCLUDE_ASM("asm/nonmatchings/game/gameAudio", func_800ACC1C);

void func_800ACC1C(u16 sequenceIndex) {
    if (sequenceIndex < TOTAL_SEQUENCES) {
        setAudioSequenceVolumes(0, 0, 32);
    }
}

//INCLUDE_ASM("asm/nonmatchings/game/gameAudio", setSfx);

void playSfx(u16 index) {
    
  if (index < TOTAL_SFX) {
      
    if (audioTypeTable[index] == SFX_TYPE) {
      
      setSfx(index + 1);
      setSfxVolume(index + 1, volumesTable[index]);

    } else {

        setAudioSequence(audioTypeTable[index], (u8*)sfxRomAddresses[index].romAddrStart, (u8*)sfxRomAddresses[index].romAddrEnd);
        setAudioSequenceVolumes(audioTypeTable[index], volumesTable[index], volumesTable[index]);
    
    }
  }
  
}

//INCLUDE_ASM("asm/nonmatchings/game/gameAudio", checkAllSfxInactive);

u8 checkAllSfxInactive(void) {

    u8 i;
    u8 count;

    count = 0;

    for (i = 0; i < MAX_ACTIVE_SFX; i++) {
        if (!gSfx[i].flags) {
            count++;
        }
    }
    
    return count == 4;

}